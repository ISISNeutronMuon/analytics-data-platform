---
- name: Ensure Lakekeeper working directory exists
  become: true
  ansible.builtin.file:
    path: "{{ lakekeeper_working_dir }}"
    state: directory
    mode: "0755"

- name: Copy bootstrap script
  become: true
  ansible.builtin.copy:
    src: bootstrap-warehouse.py
    dest: "{{ lakekeeper_working_dir }}/bootstrap-warehouse.py"
    mode: "0755"

- name: Generate warehouse templates
  become: true
  vars:
    lakekeeper_bootstrap:
      warehouse_permissions:
        "service-account-trino": ["select"]
  ansible.builtin.template:
    src: bootstrap-warehouse.json.j2
    dest: "{{ lakekeeper_working_dir }}/bootstrap-warehouse-{{ warehouse.name }}.json"
    mode: "0644"
  loop: "{{ lakekeeper_catalog.warehouses | dict2items(key_name='name') }}"
  loop_control:
    loop_var: warehouse
  register: warehouse_json_files

- name: Bootstrap Lakekeeper
  community.docker.docker_container:
    name: "{{ lakekeeper_container_name }}_bootstrap"
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command: >-
      uv run
      /opt/work/bootstrap-warehouse.py
        --lakekeeper-project-name "{{ lakekeeper_project_name }}"
        --keycloak-url {{ keycloak_url }}
        --keycloak-admin-credentials "{{ vault_keycloak_bootstrap_admin_user }}:{{ vault_keycloak_bootstrap_admin_passwd }}"
        --keycloak-user-realm {{ keycloak_realm.name }}
        --bootstrap-credentials {{ lakekeeper_bootstrap_credentials }}
        --token-scope lakekeeper
        --server-admin {{ lakekeeper_admin_user }}
        --log-level {{ lakekeeper_bootstrap_log_level }}
        --warehouse-json-file {{ warehouse_json_file | replace(lakekeeper_working_dir, '/opt/work') }}
      http://localhost:{{ lakekeeper_http_port }}
    state: started
    cleanup: true
    detach: false
    restart_policy: "no"
    recreate: true
    env:
      #
      UV_LINK_MODE: copy
      UV_PROJECT_ENVIRONMENT: /opt/uv-venv
    network_mode: host
    volumes:
      - "{{ lakekeeper_working_dir }}:/opt/work"
  loop: "{{ warehouse_json_files.results | map(attribute='dest') | list }}"
  loop_control:
    loop_var: warehouse_json_file
