---
- ansible.builtin.include_tasks: realm-token.yml

- name: Get Lakekeeper bootstrap info
  ansible.builtin.uri:
    url: "{{ lakekeeper_catalog.management_uri }}/v1/info"
    method: GET
    headers:
      Authorization: "Bearer {{ _realm_token.json['access_token'] }}"
  register: bootstrap_info

- name: Bootstrap Lakekeeper using machine user
  ansible.builtin.uri:
    url: "{{ lakekeeper_catalog.management_uri }}/v1/bootstrap"
    method: POST
    body:
      "accept-terms-of-use": true
      "is-operator": true
    body_format: json
    headers:
      Authorization: "Bearer {{ _realm_token.json['access_token'] }}"
  when: not bootstrap_info.json['bootstrapped']
  register: this
  failed_when: this.status not in (200, 204)
