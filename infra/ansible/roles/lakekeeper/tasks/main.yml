---
- name: Get infos on lakekeeper container
  community.docker.docker_container_info:
    name: "{{ lakekeeper_container_name }}"
  register: result

- name: Stop Lakekeeper instance
  community.docker.docker_container:
    name: "{{ lakekeeper_container_name }}"
    state: absent

- name: Run Lakekeeper migrations
  community.docker.docker_container:
    name: "{{ lakekeeper_container_name }}_migrate"
    image: "{{ lakekeeper_image }}"
    command: migrate
    state: started
    cleanup: true
    detach: false
    restart_policy: no
    recreate: true
    env:
      #
      LAKEKEEPER__PG_ENCRYPTION_KEY="{{ lakekeeper_store_encryption_key }}"
      LAKEKEEPER__PG_DATABASE_URL_READ="postgresql://{{ lakekeeper_store_user }}:{{ lakekeeper_store_passwd }}@postgres:5432/{{ lakekeeper_store_dbname }}"
      LAKEKEEPER__PG_DATABASE_URL_WRITE="postgresql://{{ lakekeeper_store_user }}:{{ lakekeeper_store_passwd }}@postgres:5432/{{ lakekeeper_store_dbname }}"
      LAKEKEEPER__OPENID_PROVIDER_URI="http://{{ top_level_domain }}/auth/realms/isis"
      LAKEKEEPER__OPENID_AUDIENCE=lakekeeper
      LAKEKEEPER__UI__OPENID_CLIENT_ID=lakekeeper
      RUST_LOG=warn,iceberg_catalog=trace,iceberg_catalog_bin=trace,iceberg_ext=trace
    networks:
      - name: "{{ lakekeeper_container_network }}"
    comparisons:
      networks: strict
      env: strict

- name: Start Lakekeeper container
  community.docker.docker_container:
    name: "{{ lakekeeper_container_name }}"
    image: "{{ lakekeeper_image }}"
    command: serve
    state: started
    cleanup: true
    detach: true
    restart_policy: unless-stopped
    recreate: true
    published_ports:
      - "{{ lakekeeper_http_port }}:8181"
    env:
      #
      LAKEKEEPER__BASE_URI="https://{{ top_level_domain }}/lakekeeper"
      LAKEKEEPER__UI__LAKEKEEPER_URL="https://{{ top_level_domain }}/lakekeeper"
      LAKEKEEPER__PG_ENCRYPTION_KEY="{{ lakekeeper_store_encryption_key }}"
      LAKEKEEPER__PG_DATABASE_URL_READ="postgresql://{{ lakekeeper_store_user }}:{{ lakekeeper_store_passwd }}@postgres:5432/{{ lakekeeper_store_dbname }}"
      LAKEKEEPER__PG_DATABASE_URL_WRITE="postgresql://{{ lakekeeper_store_user }}:{{ lakekeeper_store_passwd }}@postgres:5432/{{ lakekeeper_store_dbname }}"
      LAKEKEEPER__OPENID_PROVIDER_URI="http://{{ top_level_domain }}/auth/realms/isis"
      LAKEKEEPER__OPENID_AUDIENCE="lakekeeper"
      LAKEKEEPER__UI__OPENID_CLIENT_ID="lakekeeper"
      LAKEKEEPER__UI__OPENID_PROVIDER_URI="http://{{ top_level_domain }}/auth/realms/isis"
      RUST_LOG="trace,iceberg_catalog=trace,iceberg_catalog_bin=trace,iceberg_ext=trace"
    networks:
      - name: "{{ lakekeeper_container_network }}"
    comparisons:
      networks: strict
      env: strict
